# Tessera Phase III POC-1 結果報告書

**Version:** 1.0.0
**Date:** 2026-01-15
**Status:** 完了
**Author:** beachcities + Claude Opus

---

## 1. 概要

POC-1 では、8方向 ray-cast による 19^4 カーネルの軽量実装を検証した。
8GB VRAM 環境（RTX 4070 Laptop）での境界領域を特定し、安全弁の設計指針を策定した。

---

## 2. 実施内容

| POC | 内容 | 成果物 |
|-----|------|--------|
| POC-1a | インデックステーブル生成 | `ray_index.py` |
| POC-1b | ray-cast レイヤー実装 | `ray_cast.py` |
| POC-1b v2 | チャンネル混合版 + ベンチマーク | `ray_cast_v2.py` |
| 境界テスト | VRAM 限界の特定 | `ray_cast_boundary.py`, `ray_cast_boundary_extreme.py` |

---

## 3. 検証結果

### 3.1 基本性能（POC-1b）

| 項目 | 結果 | 目標 | 判定 |
|------|------|------|------|
| 順伝播 | ✅ 動作 | - | ✅ |
| 勾配フロー | ✅ 正常 | - | ✅ |
| D8 対称性 | 差分 0.000000 | 保存 | ✅ |
| パラメータ数 | 36 | 軽量 | ✅ |

### 3.2 ベンチマーク（v1 スカラー版）

| Batch Size | 時間 (ms) | Peak VRAM (MB) |
|------------|-----------|----------------|
| 16 | 0.44 | 47 |
| 32 | 0.66 | 77 |
| 64 | 1.81 | 132 |
| 128 | 3.62 | 247 |
| 256 | 6.96 | 478 |

### 3.3 ベンチマーク（v2 チャンネル混合版 c_in=3, c_out=8）

| Batch Size | 時間 (ms) | Peak VRAM (MB) |
|------------|-----------|----------------|
| 16 | 0.49 | 37 |
| 32 | 0.65 | 59 |
| 64 | 1.44 | 97 |
| 128 | 3.00 | 176 |
| 256 | 5.74 | 335 |

---

## 4. 境界領域テスト結果

### 4.1 テスト環境

- GPU: NVIDIA GeForce RTX 4070 Laptop GPU
- VRAM: 8.0 GB
- CUDA: 12.6
- PyTorch: 2.x

### 4.2 Batch Size 限界

| Batch Size | VRAM (GB) | 結果 |
|------------|-----------|------|
| 8,192 | 9.55 | ✅ (Unified Memory 使用) |
| 16,384 | - | ❌ OOM |

**限界: Batch Size 16,384 で OOM**

### 4.3 入力チャンネル (c_in) 限界

| c_in | VRAM (GB) | 結果 |
|------|-----------|------|
| 128 | 6.39 | ✅ |
| 256 | 12.75 | ✅ (Unified Memory) |
| 512 | - | ❌ OOM |

**限界: c_in=512 で OOM**

### 4.4 複数レイヤー同時保持

| レイヤー数 | パラメータ数 | VRAM (GB) | 結果 |
|------------|-------------|-----------|------|
| 1 | 1,744 | 0.17 | ✅ |
| 8 | 13,952 | 0.22 | ✅ |
| 16 | 27,904 | 0.28 | ✅ |
| 32 | 55,808 | 0.40 | ✅ |

**32 レイヤーでも余裕あり**

### 4.5 Mamba + RayCast 同時ロード

| 構成 | パラメータ数 | VRAM (GB) | 結果 |
|------|-------------|-----------|------|
| Mamba (1.9M) + RayCast | ~1.94M | 0.43 | ✅ |

**実運用構成で VRAM 使用率 5% 以下**

---

## 5. 安全弁の設計指針

### 5.1 VRAM 限界（Fact Base）

| パラメータ | OOM 発生値 | 安全限界 (50%) | 推奨値 (25%) |
|------------|-----------|----------------|--------------|
| Batch Size | 16,384 | 8,192 | **4,096** |
| c_in | 512 | 256 | **64** |
| c_out | 未到達 | - | **32** |
| レイヤー数 | 未到達 | - | **16** |

### 5.2 安全マージンの根拠

- **50% マージン**: Unified Memory への依存を避ける
- **25% マージン**: 他コンポーネント（拡散エンジン、Mamba）との共存を考慮
- **Phase II との互換性**: Batch Size 128 を維持

### 5.3 推奨運用構成
```python
SAFE_CONFIG = {
    'batch_size': 128,      # Phase II 互換
    'c_in': 6,              # 拡散スナップショット数
    'c_out': 16,            # 長距離ポテンシャルチャンネル
    'max_dist': 18,         # 盤端まで
    'use_d8_symmetry': True,
    
    # 安全弁
    'max_batch_size': 4096,
    'max_c_in': 64,
    'vram_limit_ratio': 0.7,  # 8GB × 0.7 = 5.6GB 上限
}
```

### 5.4 推定 VRAM 使用量

| 構成 | VRAM | 8GB の何%？ |
|------|------|-------------|
| 推奨構成 (Batch=128) | ~0.3 GB | 4% |
| 最大安全構成 (Batch=4096) | ~2.4 GB | 30% |
| Mamba + RayCast + 拡散 | ~1.0 GB (推定) | 13% |

---

## 6. Phase III への提言

### 6.1 確認された設計の妥当性

- ✅ 8方向 ray-cast は VRAM 効率が極めて高い
- ✅ フル 19^4 (520MB) の **1% 以下** で同等の機能を実現
- ✅ D8 対称性が完全に保存される
- ✅ 勾配が正常に流れる

### 6.2 POC-2 への推奨事項

1. **拡散エンジンの VRAM 見積もり**: POC-1 と同様の境界テストを実施
2. **統合時の VRAM 配分**: 拡散 30% + RayCast 30% + Mamba 30% + バッファ 10%
3. **安全弁の実装**: `VRAMSanitizer` に POC-1 の閾値を組み込む

### 6.3 実装優先度

| 優先度 | 項目 | 理由 |
|--------|------|------|
| 1 | 拡散エンジン (POC-2) | ray-cast の入力を生成 |
| 2 | 統合テスト | 3 コンポーネント同時動作 |
| 3 | 自己対戦への組み込み | Phase III 本番 |

---

## 7. 成果物一覧

| ファイル | 内容 |
|----------|------|
| `src/ray_index.py` | インデックステーブル生成 |
| `src/ray_cast.py` | ray-cast レイヤー (v1 スカラー版) |
| `src/ray_cast_v2.py` | ray-cast レイヤー (v2 チャンネル混合版) |
| `src/ray_cast_boundary.py` | 境界テスト (標準) |
| `src/ray_cast_boundary_extreme.py` | 境界テスト (極限) |
| `docs/POC_1_RESULTS.md` | 本報告書 |

---

## 付録 A: テスト実行ログ

### A.1 POC-1b 基本テスト
```
Device: cuda
順伝播: ✅
勾配フロー: ✅
D8 対称性: ✅ (差分 0.000000)
```

### A.2 境界テスト
```
[1] Batch Size 極限 (c_in=3, c_out=8)
  Batch=  8192: VRAM=9.55 GB ✅
  Batch= 16384: ❌ OOM - 限界発見!

[2] 複数レイヤー同時保持 (Batch=128)
  Layers=32: params=55,808 | VRAM=0.40 GB ✅

[3] Mamba + RayCast 同時ロード (Batch=128)
  Mamba (1,939,820 params) + RayCast: VRAM=0.43 GB ✅

[4] 入力チャンネル極限 (Batch=128)
  c_in=256: VRAM=12.75 GB ✅
  c_in=512: ❌ OOM - 限界発見!
```

---

*"Le symbole donne à penser."* — Paul Ricœur

*The boundary defines the possible.*
