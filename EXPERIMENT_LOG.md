# Tessera 実験ログ

## Phase II-c: 200,000 ゲーム学習実験

**実施日:** 2026-01-13 〜 2026-01-14
**実施者:** beachcities + Claude

---

## 1. 実験概要

| 項目 | 値 |
|------|-----|
| 目標 | 200,000 ゲームの自己対戦学習 |
| 開始点 | 100,000 ゲーム完了時点のチェックポイント |
| 環境 | RTX 4070 Laptop (8GB VRAM) |
| バッチサイズ | 128 |

---

## 2. 実験結果

### 2.1 最終結果

| メトリクス | 値 |
|-----------|-----|
| 総ゲーム数 | 200,096 |
| 総手数 | 34,779,675 |
| 学習時間 | 130.2 分 (2.17 時間) |
| 平均 Loss | 4.9920 |
| 最終 ELO | 1496 |
| 最高 ELO | 1517 |
| ELO 評価回数 | 790 回 |
| OOM 発生回数 | **0 回** |

### 2.2 Loss 推移

```
Game 100k: 3.7  (再開時)
Game 115k: 5.4  (ピーク - 最悪)
Game 150k: 4.0  (安定)
Game 175k: 2.3  (急降下 - 相転移)
Game 200k: 4.0  (最終 - 再上昇は正常)
```

### 2.3 相転移現象

175k 付近で Loss が 5.4 → 2.3 へ急降下する現象を観測。

**解釈:**
- Mamba が囲碁の基本パターンを「理解し始めた」瞬間
- 自己対戦では、強くなると相手も強くなるため Loss が再上昇
- ELO が安定していることから、学習は正常に進行

---

## 3. 技術的発見

### 3.1 MambaStateCapture の OOM 問題

**問題:**
- ELO 評価時に OOM が頻発
- VRAM 使用量が評価のたびに増加

**原因:**
- `MambaStateCapture` クラスの forward hook が hidden state を保持
- 参照が残り続け、GC されない

**解決:**
- `MambaStateCapture` クラスを完全削除
- Mamba 内部で状態管理（外部参照不要）

**効果:**
- 790 回の ELO 評価で OOM ゼロ

### 3.2 BATCH_SIZE と VRAM

| BATCH_SIZE | VRAM 使用率 | 安定性 |
|------------|-------------|--------|
| 32 | ~5% | ✅ |
| 64 | ~8% | ✅ |
| 128 | ~10% | ✅ |

8GB VRAM 環境では BATCH_SIZE=128 が最適。

### 3.3 best_loss 表示の問題

再開時に `best_loss: 0.0000` と表示される問題を発見。

**原因:** チェックポイント再開時の初期化ロジックの不備
**影響:** 表示のみ、学習には影響なし
**対応:** Phase III で修正予定

---

## 4. チェックポイント

### 4.1 主要チェックポイント

| ファイル | ゲーム数 | ELO |
|----------|---------|-----|
| `tessera_v4_final_game100000_elo1512.pth` | 100,000 | 1512 |
| `tessera_v4_final_game200096_elo1496.pth` | 200,096 | 1496 |

### 4.2 Tile チェックポイント

500 ゲームごとに保存、計 790 個の Tile チェックポイントを生成。

---

## 5. 可視化ツール

### Streamlit Dashboard v1.2

**機能:**
- リアルタイム進捗表示
- Loss/ELO グラフ（移動平均付き）
- ETA 計算（中央値ベース）
- フェーズ表示（序盤/中盤/終盤）

**起動:**
```bash
cd ~/GoMamba_Local
source venv/bin/activate
streamlit run streamlit_dashboard.py
```

---

## 6. 教訓と次フェーズへの示唆

### 6.1 確認された設計原則

| 原則 | 検証結果 |
|------|----------|
| GPU Complete | ✅ CPU-GPU 転送ゼロを維持 |
| Batch First | ✅ 128 バッチで安定動作 |
| Clean Room | ✅ 外部データなし、自己対戦のみ |

### 6.2 Phase III への推奨事項

1. **ルールエンジン改善**
   - 連の完全実装（Connected Components）
   - 終局判定の改善（地の計算）
   - コウの完全実装

2. **best_loss の修正**
   - 単一ゲーム最小値 → 移動平均最小値に変更

3. **19^4 テンソル設計の検討**
   - 理論的検証が必要
   - より大きな VRAM 環境での実験を推奨

---

## 7. 参考資料

- [DESIGN_SPEC_PHASE_II.md](docs/DESIGN_SPEC_PHASE_II.md)
- [DESIGN_SPEC_PHASE_III.md](docs/DESIGN_SPEC_PHASE_III.md)
- [HANDOFF.md](HANDOFF.md)

---

*実験完了: 2026-01-14 00:29 JST*
